---
import type { Album } from '../lib/albums';
import { parseInlineMarkdown } from '../lib/albums';
import { siteConfig } from '../config';

interface AlbumWithCover {
  album: Album;
  coverPhotoUrl: string | null;
}

interface Props {
  albums: AlbumWithCover[];
  parentPath?: string;
  parentToken?: string;
  isParentProtected?: boolean;
  hasParentAccess?: boolean;
}

const { albums, parentPath, parentToken, isParentProtected = false, hasParentAccess = true } = Astro.props;
const siteUrl = siteConfig.siteUrl;

// Cache version - increment to bust browser cache after thumbnail changes
const THUMBNAIL_VERSION = 2;

// Helper function to generate thumbnail URL
function getThumbnailUrl(photoUrl: string, size: 'small' | 'medium' | 'large' = 'small'): string {
  const path = photoUrl.replace('/albums/', '');
  return `/api/thumbnail?path=${encodeURIComponent(path)}&size=${size}&v=${THUMBNAIL_VERSION}`;
}

// Format date in Croatian format (DD.MM.YYYY)
function formatCroatianDate(date: Date): string {
  const day = date.getDate().toString().padStart(2, '0');
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const year = date.getFullYear();
  return `${day}.${month}.${year}`;
}
---

<div class="album-grid">
  {albums.map(({ album, coverPhotoUrl }) => {
    const albumPath = album.id.replace('/index.md', '');
    const displayTitle = album.data.title;
    const albumHasPassword = !!album.data.password;
    const isProtected = albumHasPassword || isParentProtected;
    const hasCoverPhoto = !!coverPhotoUrl;
    const isCollection = album.data.isCollection;
    // For albums inside protected parent, use parent token if album has no password
    const effectiveToken = albumHasPassword ? album.data.token : parentToken;

    return (
      <a
        href={`/photos/${albumPath}`}
        class="album-card"
        data-protected={isProtected ? "true" : undefined}
        data-title={displayTitle}
        data-date={album.data.date ? new Date(album.data.date).getTime().toString() : ""}
        data-order={album.data.order?.toString() ?? "999"}
      >
        <div class="album-thumbnail">
          {hasCoverPhoto ? (
            <>
              <img
                src={getThumbnailUrl(coverPhotoUrl, 'large')}
                alt={displayTitle}
                class="cover-image"
              />
              {isProtected && <span class="lock-icon">üîí</span>}
              {album.data.date && (
                <span class="date-badge">{formatCroatianDate(new Date(album.data.date))}</span>
              )}
            </>
          ) : (
            <div class="placeholder">
              {isProtected && <span class="lock-icon">üîí</span>}
              {album.data.date && (
                <span class="date-badge">{formatCroatianDate(new Date(album.data.date))}</span>
              )}
              <span class="folder-icon">{isCollection ? 'üìÅ' : 'üñºÔ∏è'}</span>
            </div>
          )}
          <button
            class="album-share-btn"
            data-album-path={albumPath}
            data-album-title={displayTitle}
            data-album-token={effectiveToken || ''}
            data-is-protected={isProtected.toString()}
            data-album-has-password={albumHasPassword.toString()}
            data-has-access={hasParentAccess.toString()}
            title="Share album"
            aria-label="Share album"
          >
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="18" cy="5" r="3"></circle>
              <circle cx="6" cy="12" r="3"></circle>
              <circle cx="18" cy="19" r="3"></circle>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
            </svg>
          </button>
        </div>
        <div class="album-info">
          <h3>{displayTitle}</h3>
          {album.data.description && (
            <p class="description" set:html={parseInlineMarkdown(album.data.description)} />
          )}
        </div>
      </a>
    );
  })}
</div>

<!-- Share Modal -->
<div id="album-share-modal" class="share-modal-overlay" data-site-url={siteUrl}>
  <div class="share-modal">
    <div class="share-modal-header">
      <span>Share</span>
      <button class="share-modal-close" aria-label="Close">&times;</button>
    </div>

    <!-- Warning for protected content -->
    <div class="share-modal-warning" id="album-share-warning">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
      <div>
        <strong>Protected Content</strong>
        <p>Share link includes access token. Anyone with this link can view it.</p>
      </div>
    </div>

    <!-- Preview section -->
    <div class="share-modal-preview">
      <span class="share-preview-name" id="album-share-name"></span>
    </div>

    <!-- Share buttons (no Instagram for albums) -->
    <div class="share-modal-buttons">
      <button class="share-btn share-btn-copy" id="album-copy-link">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
        Copy Link
      </button>
      <div class="share-social-row">
        <button class="share-btn share-btn-facebook" id="album-share-facebook">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
          </svg>
          Facebook
        </button>
        <button class="share-btn share-btn-linkedin" id="album-share-linkedin">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
            <rect x="2" y="9" width="4" height="12"></rect>
            <circle cx="4" cy="4" r="2"></circle>
          </svg>
          LinkedIn
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast notification -->
<div id="album-share-toast" class="album-share-toast" aria-live="polite">
  Link copied to clipboard
</div>

<style>
  .album-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
  }

  .album-card {
    display: block;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    background: white;
  }

  .album-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    text-decoration: none;
  }

  .album-thumbnail {
    position: relative;
    width: 100%;
    padding-top: 66.67%; /* 3:2 aspect ratio */
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    overflow: hidden;
  }

  .cover-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .placeholder {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
  }

  .lock-icon {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 1.5rem;
    background: rgba(255, 255, 255, 0.9);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .date-badge {
    position: absolute;
    bottom: 0.75rem;
    left: 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: white;
    background: rgba(0, 0, 0, 0.6);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    letter-spacing: 0.02em;
    font-variant-numeric: tabular-nums;
  }

  .folder-icon {
    opacity: 0.8;
  }

  .album-info {
    padding: 1rem;
  }

  .album-info h3 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
    color: var(--color-text);
  }

  .description {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .description :global(strong) {
    font-weight: 600;
    color: var(--color-text);
  }

  .description :global(em) {
    font-style: italic;
  }

  .description :global(a) {
    color: var(--color-primary, #2563eb);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .description :global(a:hover) {
    color: var(--color-hover, #1d4ed8);
  }

  /* Album share button */
  .album-share-btn {
    position: absolute;
    bottom: 0.5rem;
    right: 0.5rem;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s, transform 0.2s, background 0.2s;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .album-share-btn svg {
    color: #333;
    transition: color 0.2s;
  }

  .album-card:hover .album-share-btn {
    opacity: 1;
  }

  .album-share-btn:hover {
    transform: scale(1.1);
    background: white;
  }

  .album-share-btn:hover svg {
    color: #000;
  }

  .album-share-btn:active {
    transform: scale(0.95);
  }

  /* Share Modal */
  .share-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 100002;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }

  .share-modal-overlay.visible {
    opacity: 1;
    visibility: visible;
  }

  .share-modal {
    background: #1a1a1a;
    border-radius: 12px;
    width: 90%;
    max-width: 380px;
    max-height: 90vh;
    overflow: hidden;
    transform: scale(0.95);
    transition: transform 0.2s ease;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

  .share-modal-overlay.visible .share-modal {
    transform: scale(1);
  }

  .share-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #333;
  }

  .share-modal-header span {
    font-weight: 600;
    font-size: 1.1rem;
    color: #fff;
  }

  .share-modal-close {
    background: none;
    border: none;
    color: #888;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
    transition: color 0.2s;
  }

  .share-modal-close:hover {
    color: #fff;
  }

  .share-modal-warning {
    display: none;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: rgba(234, 179, 8, 0.15);
    border-bottom: 1px solid rgba(234, 179, 8, 0.3);
  }

  .share-modal-warning.visible {
    display: flex;
  }

  .share-modal-warning svg {
    flex-shrink: 0;
    color: #eab308;
    margin-top: 2px;
  }

  .share-modal-warning strong {
    display: block;
    color: #eab308;
    font-size: 0.85rem;
    margin-bottom: 2px;
  }

  .share-modal-warning p {
    color: #a3a3a3;
    font-size: 0.75rem;
    line-height: 1.4;
    margin: 0;
  }

  .share-modal-preview {
    padding: 1rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border-bottom: 1px solid #333;
  }

  .share-preview-name {
    font-size: 0.9rem;
    color: #e5e5e5;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .share-modal-buttons {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .share-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .share-btn svg {
    flex-shrink: 0;
  }

  .share-btn-copy {
    background: #fff;
    color: #1a1a1a;
  }

  .share-btn-copy:hover {
    background: #e5e5e5;
  }

  .share-social-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }

  .share-btn-facebook {
    background: #1877f2;
    color: #fff;
  }

  .share-btn-facebook:hover {
    background: #166fe5;
  }

  .share-btn-linkedin {
    background: #0a66c2;
    color: #fff;
  }

  .share-btn-linkedin:hover {
    background: #004182;
  }

  /* Toast notification */
  .album-share-toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: #333;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 0.9rem;
    z-index: 100003;
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
    pointer-events: none;
  }

  .album-share-toast.visible {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  @media (max-width: 768px) {
    .album-grid {
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
    }

    .album-info h3 {
      font-size: 1rem;
    }

    .description {
      font-size: 0.85rem;
    }

    /* Always show share button on mobile */
    .album-share-btn {
      opacity: 1;
    }

    .album-share-btn:hover {
      transform: none;
    }

    .share-social-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('album-share-modal') as HTMLElement;
    const closeBtn = modal?.querySelector('.share-modal-close');
    const warning = document.getElementById('album-share-warning');
    const nameDisplay = document.getElementById('album-share-name');
    const copyBtn = document.getElementById('album-copy-link');
    const facebookBtn = document.getElementById('album-share-facebook');
    const linkedinBtn = document.getElementById('album-share-linkedin');
    const toast = document.getElementById('album-share-toast');

    let currentAlbumPath = '';
    let currentToken = '';
    let currentIsProtected = false;
    let toastTimeout: ReturnType<typeof setTimeout> | null = null;

    function showToast(message: string) {
      if (!toast) return;
      toast.textContent = message;
      toast.classList.add('visible');
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toast.classList.remove('visible');
      }, 2500);
    }

    function openShareModal(
      albumPath: string,
      albumTitle: string,
      token: string,
      isProtected: boolean,
      hasAccess: boolean
    ) {
      if (!modal) return;

      currentAlbumPath = albumPath;
      currentToken = token;
      currentIsProtected = isProtected;

      // Set preview name
      if (nameDisplay) {
        nameDisplay.textContent = albumTitle;
      }

      // Show/hide warning
      if (warning) {
        if (isProtected && hasAccess && token) {
          warning.classList.add('visible');
        } else {
          warning.classList.remove('visible');
        }
      }

      modal.classList.add('visible');
      document.body.style.overflow = 'hidden';
    }

    function closeShareModal() {
      if (!modal) return;
      modal.classList.remove('visible');
      document.body.style.overflow = '';
    }

    function getShareUrl(): string {
      const siteUrl = modal?.dataset.siteUrl || window.location.origin;
      let url = `${siteUrl}/photos/${currentAlbumPath}`;

      // Add token for protected content
      if (currentIsProtected && currentToken) {
        url += `?token=${currentToken}`;
      }

      return url;
    }

    // Copy link handler
    copyBtn?.addEventListener('click', async () => {
      const url = getShareUrl();
      try {
        await navigator.clipboard.writeText(url);
        showToast('Link copied to clipboard');
        closeShareModal();
      } catch {
        showToast('Could not copy link');
      }
    });

    // Facebook share
    facebookBtn?.addEventListener('click', () => {
      const url = getShareUrl();
      window.open(
        `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
        '_blank',
        'width=600,height=400'
      );
      closeShareModal();
    });

    // LinkedIn share
    linkedinBtn?.addEventListener('click', () => {
      const url = getShareUrl();
      window.open(
        `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`,
        '_blank',
        'width=600,height=400'
      );
      closeShareModal();
    });

    // Close button handler
    closeBtn?.addEventListener('click', closeShareModal);

    // Close on overlay click
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeShareModal();
      }
    });

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal?.classList.contains('visible')) {
        closeShareModal();
      }
    });

    // Add click handlers to all share buttons
    document.querySelectorAll('.album-share-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const el = btn as HTMLElement;
        const albumPath = el.dataset.albumPath || '';
        const albumTitle = el.dataset.albumTitle || 'Album';
        const token = el.dataset.albumToken || '';
        const isProtected = el.dataset.isProtected === 'true';
        const hasAccess = el.dataset.hasAccess === 'true';

        openShareModal(albumPath, albumTitle, token, isProtected, hasAccess);
      });
    });
  });
</script>
